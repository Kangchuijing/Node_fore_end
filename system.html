<!DOCTYPE html>
<html>

<head>
    <title>
        管理系统内部页面
    </title>
    <link rel='stylesheet' href='./public/bootstrap/css/bootstrap.min.css' />
    <link rel="stylesheet" href="./public//css/reset.css">
    <link rel="stylesheet" href="./public//css/common.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="bg-primary header_title">
                <div class="title">
                    <a href="/">千锋后台管理系统</a>
                </div>
                <div class="person">
                    <div class="user">欢迎您,
                        <span id="userInfo"></span>
                    </div>
                    <button type="button" class="btn btn-primary" id="exit">退出</button>
                </div>
            </div>
        </div>
        <div class="main">
            <div class="menu">
                <ul class="nav nav-pills nav-stacked nav-pills-stacked-example">
                    <li role="presentation" class="active">
                        <a href="javasript:void(0);" style="font-size: 18px;">后台管理</a>
                    </li>
                    <li role="presentation" id="usersManager">
                        <a class="cursor">用户管理</a>
                    </li>
                    <li role="presentation " id="pinpai">
                        <a class="cursor">品牌管理</a>
                    </li>
                    <li role="presentation " id="phone">
                        <a class="cursor">手机管理</a>
                    </li>
                </ul>
            </div>
            <div id="data">
                <div class="form" id="userSearch">
                    <form class="form-inline">
                        <div class="form-group">
                            <label class="sr-only" for="searchInput">Amount (in dollars)</label>
                            <div class="input-group">
                                <div class="input-group-addon"></div>
                                <input type="text" class="form-control" id="searchInput" placeholder="请输入搜索记录">
                                <div class="input-group-addon"></div>
                            </div>
                        </div>
                        <button type="button" id="search" class="btn btn-primary">查询</button>
                    </form>
                </div>
                <div id="addItem">
                    <button>添加</button>
                    <div id="addPhone">
                        <div class="phoneForm">
                            <form action="http://localhost:3000/addPhone" enctype="multipart/form-data" method="POST">
                                <h4>新增</h4>
                                名称<input type="text" name="phoneName" placeholder="请输入手机名称"><br>
                                品牌<select name="brand" id="brand">
                                    <option value="苹果">苹果</option>
                                    <option value="小米">小米</option>
                                    <option value="三星">三星</option>
                                    <option value="黑莓">黑莓</option>
                                    <option value="google">google</option>
                                </select>
                                <br>
                                官方指导价<input type="text" name="guidancePrice" placeholder="请输入官方价格"><br>
                                二手回收价<input type="text" name="recoveryPrice" placeholder="请输入二手回收价格"><br>
                                手机图片<input type="file" name="picture" accept="image/*"><br>
                                <button type="submit">提交数据</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="table">
                    <table class="table table-hover">
                        <thead id="title">

                        </thead>
                        <tbody id="list">

                        </tbody>
                    </table>
                </div>
                <div class="button" id="button">
                    <div class="btn-toolbar" role="toolbar" aria-label="...">
                        <div class="btn-group" role="group" id="prev" aria-label="...">上一页</div>
                        <div id="btn_group" class="fl" style="margin-left: 5px">
                            <div class="btn-group active" role="group" aria-label="...">1</div>
                        </div>
                        <div class="btn-group" role="group" id="next" aria-label="...">下一页</div>
                    </div>
                </div>
                <div id="update">
                    <div id="data_form">
                        <input type="text" id="user" name="user" placeholder="请输入您的用户名">
                        <br>
                        <input type="text" id="nickname" name="nickname" placeholder="请输入您的昵称">
                        <br>
                        <input type="password" id="password" name="password" placeholder="请输入您的密码">
                        <br> 性别
                        <select name="sex" id="sex">
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                        <br> 管理员
                        <select name="isAdmin" id="isAdmin">
                            <option value="true">是</option>
                            <option value="false">否</option>
                        </select>
                        <span> 请谨慎修改此权限，如果您失去管理员身份，本次您仍然可以行使管理员权限，但在下次登录时，您将失去管理员权限</span>
                        <br> 权限级别
                        <select name="power" id="selectPower">
                            <option value="over-max">over-max</option>
                            <option value="max">max</option>
                            <option value="middle" selected>middle</option>
                            <option value="lower">lower</option>
                            <option value="more-lower">more-lower</option>
                        </select>
                        <br>
                        <button id="sure">我已确定修改个人信息</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer ">我是尾部</div>
    </div>
    <script src="./public/js/jquery-1.12.4.min.js"></script>
    <script src="./public/js/cookie.js"></script>
    <script src="./public/js/template-web.js"></script>
    <script id="users" type="text/html">
        <!-- 使用浏览器端的模板引擎渲染我们的html代码 -->
        {{each array}}
        <tr id="{{$value['_id']}}">
            <th scope="row">
                <input type="checkbox">{{$index+1}}
            </th>
            <td>
              {{$value.name}}
            </td>
            <td>
              {{$value.nickname}}
            </td>
            <td>
               {{$value.isAdmin?'是':'否' }} 
            </td> 
            <td>
                {{$value.power}}
            </td>
       
            <td>
                <!-- 管理员用户可以修改自己的信息 -->
                {{if($value.nickname == nickname)}} 
                <b class="update" up="{{$value['_id']}}">修改</b> 
                {{/if}}
                <!-- 只能删除和修改非管理员的数据 -->
               {{if(!$value.isAdmin)}}
                 <b class='delete' del="{{$value['_id']}}">删除</b>
               {{/if}}  
            </td>
                         
        </tr>
         {{/each}}
    </script>
    <script id="phoneManage" type="text/html">
        {{each array}}
            <tr id="{{$value['_id']}}">
                   <td><img src="{{$value.picture}}" alt=""></td>
                   <td>{{$value.phoneName}}</td>
                   <td>{{$value.brand}}</td>
                   <td>{{$value.guidancePrice}}</td>
                   <td>{{$value.recoveryPrice}}</td>
                   <td><b class="update" update="{{$value['_id']}}">修改</b> <b class="delete" delete="{{$value['_id']}}">删除</b></td>
            </tr>
        {{/each}}           
    </script>
    <script>
        $(function () {
            // 自调用函数，判断用户是否登录以及显示用户信息在页面上,以及搜索功能
            (function () {
                var isUserLogin = cookie.getCookie('user');
                var user = {
                    usersManager: null,    // 操作用户列表
                    userInfo: null,         // 显示用户信息
                    title: null,            // 表头
                    user_list: null,        // 用户列表
                    userSearch: null,       // 用户信息搜索
                    init: function () {    // 初始化用户信息对象
                        this.usersManager = $("#usersManager");
                        this.userInfo = $("#userInfo");
                        this.title = $("#title");
                        this.user_list = $("#list");
                        this.userSearch = $("#userSearch");
                    }
                };

                user.init();    // 初始化获取jq对象

                // 用户管理
                // 发现一个问题，可能会形成回调地狱，我们将这些ajax操作放到promise中去执行
                var pro = new Promise(function (success, fail) {
                    if (isUserLogin) {   // 用来判断用户是否登录，如果登录了，那么就可以进行下面的操作
                        success();      // 用户已登录
                    } else {
                        error();        // 用户未登录
                    }
                });
                pro.then(function () {  // 如果用户已经登录
                    if (isUserLogin.isAdmin) {    // 从cookie中得到用户的信息，判断用户时候时管理员用户
                        user.userInfo.text(isUserLogin.nickname + ',' + '(管理员用户)');

                        // 当点击用户管理的时候，又发送一次ajax请求
                        user.usersManager.click(function () {
                            user.userSearch.css('display', 'block');
                            $("#addItem").css('display', 'none');
                            $.get('http://localhost:3000/user/userManage', function (res) {
                                alert(res.msg);
                                // 如果响应码为0，表明数据成功查找，此时将数据渲染至页面
                                if (res.code == 0) {

                                    var head = `
                                    <tr class="bg-info">
                                        <th>
                                             <input type="checkbox">全选
                                        </th>
                                          <th>姓名</th>
                                          <th>昵称</th>
                                          <th>管理员</th>
                                          <th>权限</th>
                                          <th>操作</th>
                                   </tr>
                                    `;
                                    var button = new Button();
                                    button.url = 'http://localhost:3000/user/userManage';
                                    button.buildButton(res.totalPage);
                                    button.pageEvent(user, isUserLogin, head, res.data);
                                    button.rendering(user, isUserLogin, head, res.data);
                                    button.prevPage(user, isUserLogin, head);
                                    button.nextPage(res.totalPage, user, isUserLogin, head);

                                    // 当数据展示成功之后，进行下面的操作
                                    var pro = new Promise(function () {   // 第二个promise，避免产生回调地狱
                                        var person = new Person();
                                        // 获取修改和删除按钮
                                        person.update = $(".update");
                                        person.delete = $(".delete");
                                        person.delete.click(function () {   // 当点击删除按钮时，将id值传递过去
                                            person.deleteInfo($(this).attr('del'));   // 调用删除按钮的方法
                                        });
                                        person.updateInfo();
                                    })
                                }
                            });
                        });
                    }
                    else {

                        // 普通用户则不显示用户管理选项
                        user.userInfo.text(isUserLogin.nickname + ',' + '(普通用户)');
                        user.usersManager.remove();
                    }
                }, function () {    // 如果用户没有登录
                    alert('登录信息已过期，请重新登录');
                    location.href = 'http://127.0.0.1:8080/login.html';
                });


                // 搜索功能
                (function () {
                    var searchInfo = {
                        search: null,
                        searchInput: null,
                        init: function () {
                            this.search = $("#search");
                            this.searchInput = $("#searchInput");
                        }
                    };
                    // 初始化搜索按钮
                    searchInfo.init();
                    searchInfo.search.click(function () {
                        $.get('http://localhost:3000/user/search', {
                            nickname: searchInfo.searchInput.val()
                        }, function (res) {
                            alert(res.msg);
                            if (res.code == 0) {    // 如果数据查找成功
                                var head = `
                                    <tr class="bg-info">
                                        <th>
                                             <input type="checkbox">全选
                                        </th>
                                          <th>姓名</th>
                                          <th>昵称</th>
                                          <th>管理员</th>
                                          <th>权限</th>
                                          <th>操作</th>
                                   </tr>
                                    `;
                                var button = new Button();
                                button.rendering(user, isUserLogin, head, res.data)
                            }
                        });
                    });
                })();

                // 手机管理
                var phone = new Promise(function (success, failed) {
                    if (isUserLogin) {   // 用来判断用户是否登录，如果登录了，那么就可以进行下面的操作
                        success();      // 用户已登录
                    } else {
                        error();        // 用户未登录
                    }
                });
                phone.then(function () {
                    var $phone = $("#phone");
                    var $addItem = $("#addItem");
                    var $addPhone = $("#addPhone");
                    $phone.click(function () {
                        user.userSearch.css('display', 'none');
                        $addItem.css('display', 'block').find('button').text('添加手机');
                        $addItem.click(function () {
                            $addPhone.css('display', 'block');
                        });
                        var pro = new Promise(function (success, failed) {
                            $.get('http://localhost:3000/phoneManager', function (res) {
                                alert(res.msg);

                                if (res.code == 0) {
                                    // 查找手机信息成功
                                    var head = `
                                <tr class="bg-info">
                                        <th>
                                             图片
                                        </th>
                                          <th>手机名称</th>
                                          <th>所属品牌</th>
                                          <th>官方指导价</th>
                                          <th>二手回收价</th>
                                          <th>操作</th>
                                </tr>
                                `;
                                    user.title[0].innerHTML = head;
                                    var html = template('phoneManage', {
                                        array: res.data
                                    });
                                    console.log(res);
                                    user.user_list[0].innerHTML = html;

                                    // 实例一个按钮对象
                                    var button = new phoneOperate();
                                    // 点击按钮请求的地址
                                    button.url = 'http://localhost:3000/phoneManager';
                                    // 生成按钮的个数
                                    button.buildButton(res.totalPage);
                                    // 上一页
                                    button.prevPage(user, isUserLogin, head);
                                    // 页数的点击事件
                                    button.pageEvent(user, isUserLogin, head);
                                    // 下一页
                                    button.nextPage(res.totalPage, user, isUserLogin, head);

                                    // 当列表成功显示
                                    // 实例一个手机对象
                                    var phone = new Phone();
                                    // 当用户点击删除按钮时
                                    var $delete = $(".delete");

                                    $("#list").on('click', '.delete', function () {
                                        console.log(111);
                                        phone.delete = $(this);
                                        phone.deletePhone($(this).attr('delete'));
                                    });
                                    success(res);
                                } else {
                                    failed();
                                }
                            });
                        });

                    });
                }, function () {
                    alert('请登录');
                    location.href = 'http://127.0.0.1:8080/login.html';
                }).then(function (res) {


                }, function () {

                });
            })();

            // 点击退出登录
            (function () {
                var exit = {
                    exit: null,
                    init: function () {
                        this.exit = $("#exit");
                    }
                };
                exit.init(); // 初始化退出对象
                // 当退出按钮点击时退出登录
                exit.exit.click(function () {
                    // 首先将cookie信息清除
                    cookie.setCookie('user', '', new Date(0));
                    // 清除cookie信息的同时刷新页面，此时获取不到页面的cookie信息，就会返回到登录页面
                    location.reload();
                });
            })();


            // 按钮点击换页功能

            // 按钮构造函数
            class Button {
                constructor(btnObj) {
                    this.prev = $("#prev");
                    this.btn_group = $("#btn_group");
                    this.next = $("#next");
                    this.active = 1;  // 默认激活的按钮编号
                    this.currentButton = null;

                }

                activeButton(ele) {
                    // 这里简单的做一个排他
                    this.btn_groups.each(function (index, item) {

                        $(item).find(".btn-group").removeClass("active")
                    })
                    ele.addClass("active");
                    this.active = ele.text();
                }

                // 点击上一页
                prevPage(user, isUserLogin, head) {
                    var _this = this;
                    this.prev.click(function () {
                        // 每次点击的时候将当前活动按钮减一
                        _this.active = _this.active <= 1 ? 1 : --_this.active;
                        // 保存当前点击的按钮,方便获取其中的数据
                        _this.currentButton = $(".btn" + _this.active);
                        // 将当前的按钮设置为高亮
                        _this.activeButton(_this.currentButton);
                        // 同时发送ajax请求从后台更新数据
                        _this.getData(_this.url, user, isUserLogin, head, _this.currentButton)
                    })
                }

                // 为每个按钮注册点击事件
                // 点击页数按钮显示相应的页数
                pageEvent(user, isUserLogin, head) {
                    var _this = this;
                    var btnGroup = this.btn_group.find('.btn-group');
                    btnGroup.click(function () {
                        var that = this;
                        // 将当前点击的按钮激活为活动按钮
                        _this.activeButton($(this));
                        _this.getData(_this.url, user, isUserLogin, head, that);
                    })
                }


                // 点击下一页
                nextPage(totalPage, user, isUserLogin, head) {
                    var _this = this;
                    this.next.click(function () {
                        // 每次点击的时候将当前活动按钮加一
                        _this.active = _this.active >= totalPage ? totalPage : ++_this.active;
                        // 保存当前操作的对象
                        _this.currentButton = $(".btn" + _this.active);
                        // 将当前操作的对象置为活动对象
                        _this.activeButton(_this.currentButton);
                        // 同时从后台获取更新数据
                        _this.getData(_this.url, user, isUserLogin, head, _this.currentButton)
                    });
                }

                // 生成按钮的个数
                buildButton(num) {
                    var str = "";
                    for (var i = 0; i < num; i++) {
                        str += `
                             <div id="btn_group" class="fl btn_groups" style="margin-left: 5px">
                                 <div class="btn-group btn${i + 1}" role="group" aria-label="...">${i + 1}</div>
                              </div>
                          `;
                    }
                    this.btn_group.html(str);
                    // 找到所有的按钮
                    this.btn_groups = this.btn_group.find(".btn_groups");

                    // 将当前点击的按钮激活为活动按钮
                    this.activeButton(this.btn_group.find('.btn1'));

                }

                // 获取数据
                getData(url, user, isUserLogin, head, that) {
                    var pro = new Promise(function (success, failed) {
                        $.get(url,
                            {
                                page: $(that).text()
                            }, function (res) {

                                if (res.code == 0) {
                                    success(res);
                                } else {
                                    failed();
                                }
                            }
                        );
                    });

                    pro.then(function (res) {
                        user.title[0].innerHTML = head;
                        // 渲染我们的数据
                        var html = template('users', {
                            array: res.data,
                            nickname: isUserLogin.nickname  // 传入用户的nickname，用来做数据的修改
                        });
                        // 将数据写入到DOM中
                        user.user_list[0].innerHTML = html;

                        var pro = new Promise(function (success, failed) {
                            var person = new Person();
                            person.update = $(".update");
                            person.delete = $(".delete");
                            person.delete.click(function () {   // 当点击删除按钮时
                                person.deleteInfo($(this).attr('del'));   // 调用删除按钮的方法
                            });
                            person.updateInfo();
                        });
                    }, function () {

                    });
                }

                // 渲染页面
                rendering(user, isUserLogin, head, data) {
                    user.title[0].innerHTML = head;
                    // 渲染我们的数据
                    var html = template('users', {
                        array: data,
                        nickname: isUserLogin.nickname  // 传入用户的nickname，用来做数据的修改
                    });
                    // 将数据写入到DOM中
                    user.user_list[0].innerHTML = html;

                }

            }

            // 用户信息操作
            class Person {
                constructor() {
                    this.update = null;     // 获取修改按钮
                    this.delete = null;     // 获取删除按钮
                }
                deleteInfo(eleId) {
                    $.post('http://localhost:3000/user/delete', {
                        id: eleId
                    }, function (res) {
                        alert(res.msg);
                        if (res.code == 0) {  // 如果后台返回的信息表明数据已经删除，此时将页面上的DOM元素也移除
                            $("#" + eleId).remove();
                        }
                    });
                }
                updateInfo() {
                    var $update = $("#update");         // 获取修改按钮
                    var $data_form = $("#data_form");
                    // 获取用户表单元素
                    var $user = $("#user");
                    var $nickname = $("#nickname");
                    var $password = $("#password");
                    var $sex = $("#sex");
                    var $isAdmin = $("#isAdmin");
                    var $selectPower = $("#selectPower");
                    var $sure = $("#sure");     // 确定修改按钮
                    // 当用户点击修改按钮的同时，应该从后台获取到用户的数据
                    this.update.click(function () {
                        var _this = this;
                        $.get('http://localhost:3000/userInfo', {
                            id: $(_this).attr('up')
                        }, function (res) {
                            $user.val(res.data[0].name);
                            $nickname.val(res.data[0].nickname);
                            $password.val(res.data[0].password);
                            $sex.val(res.data[0].sex);
                            $isAdmin.val(res.data[0].isAdmin ? "是" : "否");
                            $selectPower.val(res.data[0].power);
                        });

                        $update.fadeIn(200);
                    });
                    $update.click(function () {     // 当用户点击非表单部分时隐藏表单
                        $(this).fadeOut(200);
                    });
                    $data_form.click(function (e) {  // 阻止事件冒泡，防止用户点击到表单时表单也消失
                        e.stopPropagation();
                    });

                    $sure.click(function () {
                        var data = {
                            name: $user.val(),
                            nickname: $nickname.val(),
                            password: $password.val(),
                            sex: $sex.val(),
                            isAdmin: $isAdmin.val(),
                            power: $selectPower.val(),
                        };
                        $.post('http://localhost:3000/user/update', data, function (res) {
                            console.log(res);
                        });
                    });

                }
            }

            // 手机添加删除

            class Phone {
                constructor() {
                    this.delete = null;
                    this.update = null;
                }
                deletePhone(id) {
                    $.get('http://localhost:3000/phoneManager/delete', {
                        pid: id
                    }, function (res) {
                        if (res.code == 0) {
                            $("#" + id).remove();
                        } else {
                            alert(res.code);
                        }
                    })
                }
            }

            // 手机操作继承按钮操作，重写按钮的获取数据方法
            class phoneOperate extends Button {
                constructor() {
                    super();
                }
                getData(url, user, isUserLogin, head, that) {
                    var pro = new Promise(function (success, failed) {
                        $.get(url,
                            {
                                page: $(that).text()
                            }, function (res) {

                                if (res.code == 0) {
                                    success(res);
                                } else {
                                    failed();
                                }
                            }
                        );
                    });

                    pro.then(function (res) {
                        console.log(111);
                        user.title[0].innerHTML = head;
                        // 渲染我们的数据
                        var html = template('phoneManage', {
                            array: res.data
                        });
                        // 将数据写入到DOM中
                        user.user_list[0].innerHTML = html;


                    }, function () {

                    });

                }
            }
        });
    </script>
</body>

</html>